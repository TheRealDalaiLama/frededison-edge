map $request_uri $glyph_allowed {
  default 0;
  include /etc/nginx/glyph_allow.map;
}

# Triad (static mode): apex HTTPS, numerics HTTP. All /api/* -> 403.
# RL zones defined (not used in static); strict CSP everywhere.

# ---- Rate-limit zones (http context) ----
limit_req_zone $binary_remote_addr zone=rl_activation:10m rate=2r/s;
limit_req_zone $binary_remote_addr zone=rl_dm_text:50m rate=20r/s;

# ========= Apex .COM =========
server { listen 80; server_name frededison.com; return 301 https://$host$request_uri; }
server {
  listen 443 ssl http2; server_name frededison.com;
  ssl_certificate /etc/letsencrypt/live/frededison.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/frededison.com/privkey.pem;
  include /etc/nginx/snippets/ocsp_stapling.conf;
  add_header Strict-Transport-Security "max-age=31536000" always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;
  add_header X-Frame-Options DENY always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; connect-src 'self'; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests" always;

  root /srv/fred/www/frededison.com/public/current; index index.html;
  location / { try_files $uri $uri/ =404; }
  location ^~ /api/ { return 403; }
}

# ========= Apex .ORG =========
server { listen 80; server_name frededison.org; return 301 https://$host$request_uri; }
server {
  listen 443 ssl http2; server_name frededison.org;
  ssl_certificate /etc/letsencrypt/live/frededison.org/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/frededison.org/privkey.pem;
  include /etc/nginx/snippets/ocsp_stapling.conf;
  add_header Strict-Transport-Security "max-age=31536000" always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;
  add_header X-Frame-Options DENY always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; connect-src 'self'; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests" always;

  root /srv/fred/www/frededison.org/public/current; index index.html;
  location / { try_files $uri $uri/ =404; }
  location ^~ /api/ { return 403; }
}

# ========= Apex .NET =========
server { listen 80; server_name frededison.net; return 301 https://$host$request_uri; }
server {
  listen 443 ssl http2; server_name frededison.net;
  ssl_certificate /etc/letsencrypt/live/frededison.net/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/frededison.net/privkey.pem;
  include /etc/nginx/snippets/ocsp_stapling.conf;
  add_header Strict-Transport-Security "max-age=31536000" always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;
  add_header X-Frame-Options DENY always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; connect-src 'self'; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests" always;

  root /srv/fred/www/frededison.net/public/current; index index.html;
  location / { try_files $uri $uri/ =404; }
  location ^~ /api/ { return 403; }
}


# ========= Numeric .COM (HTTPS) =========
server {
  listen 443 ssl http2; listen [::]:443 ssl http2;
  # server_name ~^(?<id>\d+)\.frededison\.com$;
  server_name ~^(?<id>[0-9]+)\.frededison\.com$;
  ssl_certificate     /etc/letsencrypt/live/wildcard.frededison.com/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/wildcard.frededison.com/privkey.pem;
  include /etc/nginx/snippets/ocsp_stapling.conf;
  # include /etc/nginx/snippets/ocsp_stapling.conf;  # (optional hardening)

  add_header Strict-Transport-Security "max-age=31536000" always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy strict-origin-when-cross-origin always;
  add_header X-Frame-Options DENY always;
  add_header X-Id $id always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; connect-src 'self'; img-src 'self' data:; style-src 'self'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'; form-action 'self'; upgrade-insecure-requests" always;

  root /srv/fred/www/frededison.com/public/current; index index.html;

  # acceptance fixtures (explicit denies)
  location = /api/anything          { return 403; }
  location = /api/v1/g/not_allowed/ { return 403; }

  # glyph gateway — allow-listed only
  location ^~ /api/v1/g/ {
    if ($glyph_allowed = 0) { return 403; }   # deny-by-default via map
    limit_req zone=rl_dm_text burst=40 nodelay;
    default_type application/json;
    return 200 '{"ok":true,"edge":"com","sub":"$id","path":"$uri"}';
  }

  # default deny for everything else under /api
  location ^~ /api/ { return 403; }

  location / { try_files $uri $uri/ =404; }
}
# ========= Numeric .COM (HTTP → HTTPS) =========
server {
  listen 80;
  listen [::]:80;
  server_name ~^[0-9]+\.frededison\.com$;
  return 301 https://$host$request_uri;
}
